
# for flashing : press boot button for 2-3 seconds before the serial connection initialize
# After OTA update, the EN (reset) button must be pressed to run firmware
      
# external_components:
  # - source: 
      # type: git
      # url: https://github.com/nliaudat/esphome_ai_component
      # ref: main
    # components: [legacy_meter_reader_tflite]
      
external_components:    
  - source:
      type: local
      path: components 
    components: [meter_reader_tflite, tflite_micro_helper, esp32_camera_utils, flash_light_controller, value_validator] #, ssocr_reader] 
      


############## General configuration

substitutions:

  name: s3cam-tflite #no special caracters
  friendly_name: "S3 camera tflite"
  id_prefix: "s3_cam_tflite" #if you have more than one board, it could be usefull to remane all the "id:prefix_xxxx" with a decicaded prefix
  # name: esp-cam-2mb #no special caracters
  # friendly_name: "esp-cam-2mb"
  # id_prefix: "esp_cam_2mb" #if you have more than one board, it could be usefull to remane all the "id:prefix_xxxx" with a decicaded prefix
 
  revision: "1.3"
  esphome_min_version: "2025.12.0"

  # Board Selection (s3_cam, aithinker)
  # board_variant: s3_cam

  
  # Meter settings
  meter_unit: L # Unit of measurement for the meter (e.g. mÂ³, kWh, L) (https://developers.home-assistant.io/docs/core/entity/sensor/https://developers.home-assistant.io/docs/core/entity/sensor/)
  meter_device_class: water # device class for the meter (e.g. water, energy, gas)
  meter_state_class: total_increasing # state class for the meter (e.g. total_increasing, total, measurement)
  
    
  # camera
  camera_pixel_format: JPEG # (cropping implementation is faster with RGB888 format) | Displays: RGB565, RGB888 | Cameras: YUV422, YUV420, RAW | Efficiency: Grayscale, YUV420, JPEG
  # camera_pixel_format: GRAYSCALE 
  camera_resolution: 640x480 #800x600 #640x480 #https://esphome.io/components/esp32_camera.html
  # camera_jpeg_quality: 10 # From 10 (best) to 63 (worst). | Must be 0 if non JPEG
  camera_jpeg_quality: 10
  # camera_max_framerate: 1fps
  camera_max_framerate: 5fps # Increased for performance testing
  camera_idle_framerate: 0.2fps
      
  #time
  TZ: Europe/Zurich #timezone
  reboot_days_of_week: MON
  reboot_hours: 5
  reboot_minutes: 0
  reboot_seconds: 0

  
preferences:
  flash_write_interval: 60min
  

ota:
  - platform: esphome

safe_mode:

# network:
    # enable_ipv6: false
    

api:
  reboot_timeout: 0s # do not reboot if hassio connection is lost.

globals:
  - id: ${id_prefix}_crop_zones
    type: std::string
    max_restore_data_length: 254 
    initial_value: "\"[]\""
    
    # #debug config 
    # initial_value: '"[[9, 10, 49, 74], [64, 10, 104, 74], [118, 9, 158, 81], [173, 9, 213, 81], [230, 9, 270, 81], [286, 10, 326, 82], [339, 11, 379, 83], [394, 10, 434, 82]]"'
    #    # Note: The outer quotes are escaped with single quotes + double quotes ("...")

tflite_micro_helper:
  debug: false

esp32_camera_utils:
  id: ${id_prefix}_camera_utils
  camera_id: ${id_prefix}_espcam
  debug: false
  ### zoom availale for OV2640, OV3660, OV5640, SC101IOT, SC030IOT from crop zones (explicit)
  # camera_window:  # can be set in http://[hassio]/developer-tools/action > esphome.[s3cam_tflite]_set_camera_window
  #   offset_x: 928 # multiple of 4
  #   offset_y: 480 # multiple of 4
  #   width: 448 # multiple of 4 or 16 if rotation enabled and 4:3 proportions with height for best quality
  #   height: 88 #  multiple of 4 or 16 if rotation enabled and 4:3 proportions with width for best quality

  # enable_rotation: true
  # rotation: 270 # 0, 90, 180, 270 (special case built-in "accelerated" for 90, 180, 270 )

  
  # enable_scaler: true
  # scaler:
  #   width: 640
  #   height: 480
    
  # enable_cropper: true
  # cropper:
  #   width: 320
  #   height: 240
  #   offset_x: 0
  #   offset_y: 0
  
  # enable_drawing: true

  debug_memory: false

# optional : flash light at taking image
flash_light_controller:
  id: ${id_prefix}_flash_controller
  flash_light: ${id_prefix}_flash
  flash_pre_time: 7000ms # 7 seconds before update (time to stabilize) (works with 5sec on my board)
  flash_post_time: 200ms # 2 seconds after update (works with 100ms on my board)
  debug: false


value_validator:
  id: ${id_prefix}_validator
  # Basic Validation
  allow_negative_rates: false          # Allow values < previous value (default: false)
  max_absolute_diff: 300               # Max allowed absolute change (default: 100)
  # max_rate_change: 0.15                # Max rate change as percentage (default: 15%)
    
  # Smart Validation
  enable_smart_validation: true        # Enable adaptive validation (default: true)
  smart_validation_window: 5           # Window size for pattern analysis (default: 5)
    
  # Confidence Thresholds
  high_confidence_threshold: 0.95      # Threshold for high confidence (default: 90%)
  per_digit_confidence_threshold: 0.95 # Min confidence per digit (default: 85%)
  strict_confidence_check: true       # Require all digits meet threshold (default: false)
    
  # Memory Management
  max_history_size: 50kB               # Max history memory usage (default: 50kB)


meter_reader_tflite:
  id: ${id_prefix}_meter_reader
  validator: ${id_prefix}_validator
  # confidence_threshold: 0.85 # Only if validator is disabled
  camera_id: ${id_prefix}_espcam
  model: "digit_recognizer_v4_10cls_RGB.tflite"
  # model: "digit_recognizer_v4_10cls_GRAY.tflite"

  update_interval: 60s

  debug: false
  debug_image: false # static embedded image (debug.jpg)
  debug_image_out_serial: false
  debug_memory: false
  debug_timing: false


  # Preview of what the AI sees (Rotated Live Cam)
  # Set to true to enable continuous updates, or false for on-demand only (via button)
  generate_preview: false # need web_server: port: 80 (wait for update_interval to be reached)
  # show_crop_areas: true # DEV (not ready for production) Draw boxes on preview



  crop_zones_global: ${id_prefix}_crop_zones  # Reference the global variables set in globals_AI_component.yaml | To update, use http://[hassio]/developer-tools/action >esphome.[s3cam_tflite]_set_crop_zones | to get, use the tools>draw_regions.py
  flash_light_controller: ${id_prefix}_flash_controller
  
  value_sensor: ${id_prefix}_meter_value
  confidence_sensor: ${id_prefix}_meter_confidence
  

  inference_logs: ${id_prefix}_inference_logs
  main_logs: ${id_prefix}_main_logs
  
  
  
  # enable_flash_calibration: false # still in dev

  ### Advanced parameters
  # frame_request_timeout: 15000  # ms (1000-60000)

  # Pool efficiency monitoring (optional, requires DEBUG_METER_READER_MEMORY)
  # pool_job_efficiency_sensor: ${id_prefix}_pool_job_efficiency
  # pool_result_efficiency_sensor: ${id_prefix}_pool_result_efficiency
  # arena_efficiency_sensor: ${id_prefix}_arena_efficiency
  # heap_fragmentation_sensor: ${id_prefix}_heap_fragmentation

  unload_button: ${id_prefix}_unload_btn
  reload_button: ${id_prefix}_reload_btn

# ssocr_reader: #seven segment reader (dev) / do not if using meter_reader_tflite
#   id: ssocr_main
#   update_interval: 60s
#   threshold_level: 128
#   digit_count: 8
#   # Adjust crop to focus EXACTLY on the digits
#   crop_x: 0
#   crop_y: 0
#   crop_w: 0
#   crop_h: 0
#   value:
#     name: "SSOCR Value"

# analog_reader: # DEV !
#   id: analog_main
#   camera_id: ${id_prefix}_espcam
#   value_sensor:
#     name: "Analog Total"
#   dials: 
#     - id: dial_1
#       scale: 1.0 
#       crop_x: 0
#       crop_y: 0
#       crop_w: 100
#       crop_h: 100
#       min_angle: 0
#       max_angle: 360
#       angle_offset: 0 # 0=North, 90=East
#       min_value: 0
#       max_value: 10

# web_server: # needed if generate_preview: true
  # port: 80

packages:
  # Board Configuration (Mutually Exclusive)
  # - !include board_freenove_esp32-s3-n8r8.yaml
  # - !include board_Seeed_Studio_XIAO_ESP32-S3_sense.yaml
  # - !include board_generic_esp32-s3-n16r8.yaml
  # - !include board_wrover_kit.yaml
  # - !include board_m5stack_psram.yaml
  # - !include board_esp32cam_aithinker.yaml #esp32_camera.yaml > power_down_pin must be enabled
  - !include board_AI-On-The-Edge-Cam_Esp32-S3.yaml

  # - !include debug_board.yaml
  
  # Component-specific controls (comment to disable individual controls)
  - !include meter_reader_tflite_controls.yaml
  - !include value_validator_controls.yaml
  - !include flash_light_controller_controls.yaml
  - !include esp32_camera_utils_controls.yaml

  
  # camera configs
  - !include camera_options.yaml
  - !include esp32_camera.yaml
  # - !include camera_webserver.yaml
  
  # network choice
  - !include wifi.yaml
  # - !include lan.yaml # only for AI-On-The-Edge-Cam_Esp32-S3.yaml + wifi must be disabled
  
  # others
  - !include globals.yaml
  - !include switch_others.yaml
  - !include sensor_others.yaml
  - !include logger.yaml 
  - !include time.yaml
