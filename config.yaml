
# for flashing : press boot button for 2-3 seconds before the serial connection initialize
# After OTA update, the EN (reset) button must be pressed to run firmware
      
# external_components:
  # - source: 
      # type: git
      # url: https://github.com/nliaudat/esphome_ai_component
      # ref: main
    # components: [legacy_meter_reader_tflite]
      
external_components:    
  - source:
      type: local
      path: components 
    components: [meter_reader_tflite, tflite_micro_helper, esp32_camera_utils, flash_light_controller] 
      


############## General configuration

substitutions:
  # Global switch for memory debugging
  debug_memory_enabled: "true"


  name: s3cam-tflite #no special caracters
  friendly_name: "S3 camera tflite"
  id_prefix: "s3_cam_tflite" #if you have more than one board, it could be usefull to remane all the "id:prefix_xxxx" with a decicaded prefix
  revision: "1.2"
  
  # Meter settings
  meter_unit: "L" # Unit of measurement for the meter (e.g. mÂ³, kWh, L) (https://developers.home-assistant.io/docs/core/entity/sensor/https://developers.home-assistant.io/docs/core/entity/sensor/)
  
  # camera
  # camera_pixel_format: JPEG # (cropping implementation is faster with RGB888 format) | Displays: RGB565, RGB888 | Cameras: YUV422, YUV420, RAW | Efficiency: Grayscale, YUV420, JPEG
  camera_pixel_format: GRAYSCALE 
  camera_resolution: 640x480 #800x600 #640x480 #https://esphome.io/components/esp32_camera.html
  # camera_jpeg_quality: 10 # From 10 (best) to 63 (worst). | Must be 0 if non JPEG
  camera_jpeg_quality: 10
  # camera_max_framerate: 1fps
  camera_max_framerate: 5fps # Increased for performance testing
  camera_idle_framerate: 0.2fps
      
  #time
  TZ: "Europe/Zurich" #timezone
  reboot_days_of_week: "MON"
  reboot_hours: "5"
  reboot_minutes: "0"
  reboot_seconds: "0"

  
preferences:
  flash_write_interval: 60min
  

ota:
  - platform: esphome

safe_mode:

# network:
    # enable_ipv6: false
    

api:
  reboot_timeout: 0s # do not reboot if hassio connection is lost.

tflite_micro_helper:
  debug: true

esp32_camera_utils:
  id: camera_utils
  camera_id: ${id_prefix}espcam
  debug: true
  ### zoom availale for OV2640, OV3660, OV5640, SC101IOT, SC030IOT from crop zones (explicit)
  camera_window:  # can be set in http://[hassio]/developer-tools/action > esphome.[s3cam_tflite]_set_camera_window
    offset_x: 928 # multiple of 4
    offset_y: 480 # multiple of 4
    width: 448 # multiple of 4 and 4:3 proportions with height for best quality
    height: 88 #  multiple of 4 and 4:3 proportions with width for best quality

  enable_rotation: true
  rotation: 15 # 0, 90, 180, 270 (special case built-in "accelarated" for 90, 180, 270 )

  
  # enable_scaler: true
  # scaler:
  #   width: 640
  #   height: 480
    
  # enable_cropper: true
  # cropper:
  #   width: 320
  #   height: 240
  #   offset_x: 0
  #   offset_y: 0

  
  enable_drawing: true
  debug_memory: ${debug_memory_enabled}

# optional : flash light at taking image
flash_light_controller:
  id: flash_controller
  flash_light: ${id_prefix}flash
  flash_pre_time: 7000ms # 7 seconds before update (time to stabilize)
  flash_post_time: 2000ms # 2 seconds after update
  debug: true


meter_reader_tflite:
  id: meter_reader
  camera_id: ${id_prefix}espcam
  # model: "digit_recognizer_v4_10cls_RGB.tflite"
  model: "digit_recognizer_v4_10cls_GRAY.tflite"

  update_interval: 60s
  debug: true

  debug_image: false # static embedded image (debug.jpg)
  debug_image_out_serial: false
  
  debug_memory: ${debug_memory_enabled}

  
  # Image Rotation (required for preview to show rotated digits)
  # rotation: "90"
  enable_rotation: false

  # Preview of what the AI sees (Rotated Live Cam)
  # Set to true to enable continuous updates, or false for on-demand only (via button)
  generate_preview: false



  crop_zones_global: crop_zones  # Reference the global variables set in globals_AI_component.yaml | To update, use http://[hassio]/developer-tools/action >esphome.[s3cam_tflite]_set_crop_zones | to get, use the tools>draw_regions.py
  flash_light_controller: flash_controller
  ### Enhanced validation parameters
  allow_negative_rates: false    # Prevent meter rollbacks
  max_absolute_diff: 300         # Maximum allowed absolute difference

  value_sensor: meter_value
  confidence_sensor: meter_confidence
  inference_logs: inference_logs
  main_logs: main_logs

  ### Advanced parameters
  # frame_request_timeout: 15000  # ms (1000-60000)
  # high_confidence_threshold: 0.90  # (0.5-1.0)


packages:

  # board choice
  # board: !include board_freenove_esp32-s3-n8r8.yaml
  board: !include board_AI-On-The-Edge-Cam_Esp32-S3.yaml
  # board: !include board_Seeed_Studio_XIAO_ESP32-S3_sense.yaml
  debug: !include debug_board.yaml
  
  # AI components
  switch_AI_component: !include switch_AI_component.yaml
  sensor_AI_component: !include sensor_AI_component.yaml
  globals_AI_component: !include globals_AI_component.yaml ## where to set your crop zones
  text_sensor_AI_component: !include text_sensor_AI_component.yaml
  number_AI_component: !include number_AI_component.yaml
  button_AI_component: !include button_AI_component.yaml
  api_AI_component: !include api_AI_component.yaml
  
  # camera configs
  camera_options: !include camera_options.yaml
  esp32_camera: !include esp32_camera.yaml
  # camera_webserver: !include camera_webserver.yaml
  
  # network choice
  wifi: !include wifi.yaml
  # lan: !include lan.yaml # only for AI-On-The-Edge-Cam_Esp32-S3.yaml + wifi must be disabled
  
  # others
  globals: !include globals.yaml
  switch_others: !include switch_others.yaml
  sensor_others: !include sensor_others.yaml
  logger: !include logger.yaml 
  time: !include time.yaml









