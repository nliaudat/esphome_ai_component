# web_server:
#   port: 80

api:
  services:
    - service: get_meter_data
      then:
        - lambda: |-
            auto val = id(meter_reader).get_value_sensor()->state;
            auto conf = id(meter_reader).get_confidence_sensor()->state;
            // auto valid = ... (if we had a validation accessor)
            
            // Construct JSON response
            // "api.respond" automatically serializes the data
            // api.respond({
            //   {"value", val},
            //   {"confidence", conf},
            //   {"status", "ok"}
            // });
            ESP_LOGD("api", "Meter Data: Value=%.2f, Confidence=%.2f", val, conf);

    - service: set_crop_zones
      variables:
        zones: string
      then:
        - text_sensor.template.publish:
            id: crop_zones_sensor
            state: !lambda 'return zones;'
        - lambda: |-
            id(crop_zones) = zones;  // Update global var
            id(meter_reader).set_crop_zones(zones);
            
    - service: set_camera_window
      variables:
        offset_x: int
        offset_y: int
        width: int
        height: int
      then:
        - lambda: |-
            if (offset_x >= 0 && offset_y >= 0 && width > 0 && height > 0) {
              id(meter_reader).set_camera_window(offset_x, offset_y, width, height);
            }
    
    # - service: auto_camera_window
      # then:
        # - lambda: |-
            # id(meter_reader).set_camera_window_from_crop_zones();
    
    - service: reset_camera_window
      then:
        - lambda: 'id(meter_reader).reset_camera_window();'
    
    - service: trigger_inference
      then:
        - lambda: 'id(meter_reader).force_flash_inference();'

    - service: start_flash_calibration
      then:
        - lambda: 'id(meter_reader).start_flash_calibration();'

# button:
#   - platform: template
#     name: "Take Preview Picture"
#     id: take_preview_btn
#     on_press:
#       - lambda: |-
#           id(meter_reader).capture_preview();





